<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Job Portal</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="https://img.icons8.com/color/96/000000/india.png">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 100px auto 50px;
            padding: 0 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .admin-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-title h1 {
            color: var(--dark-color);
            margin: 0;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: var(--transition);
            border-bottom: 4px solid var(--primary-color);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .stat-card p {
            color: var(--gray-color);
            font-size: 1.1rem;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 15px 30px;
            background: var(--gray-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            color: var(--dark-color);
        }

        .admin-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }

        th {
            background: var(--gray-light);
            font-weight: 600;
            color: var(--dark-color);
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-reviewed {
            background: #cce5ff;
            color: #004085;
        }

        .status-accepted {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .btn-edit {
            background: #4cc9f0;
            color: white;
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
        }

        .btn-toggle {
            background: var(--warning-color);
            color: white;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .logout-btn {
            background: var(--danger-color);
            color: white;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .back-btn {
            background: var(--gray-color);
            color: white;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }

            .admin-tabs {
                flex-direction: column;
            }

            .admin-tab {
                width: 100%;
                text-align: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-user-shield"></i>
                <span>Admin Panel</span>
            </div>
            <a href="/" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Job Portal
            </a>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-header">
            <div class="admin-title">
                <i class="fas fa-user-shield" style="font-size: 36px; color: var(--primary-color);"></i>
                <div>
                    <h1>Admin Dashboard</h1>
                    <p style="color: var(--gray-color); margin-top: 5px;">Manage jobs, applications, and users</p>
                </div>
            </div>
            <button class="logout-btn" id="adminLogoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <div class="admin-stats" id="adminStats">
            <!-- Stats will be loaded here -->
        </div>

        <div class="admin-tabs">
            <div class="admin-tab active" data-tab="jobs">Manage Jobs</div>
            <div class="admin-tab" data-tab="applications">Applications</div>
            <div class="admin-tab" data-tab="postJob">Post New Job</div>
            <div class="admin-tab" data-tab="users">Users</div>
        </div>

        <!-- Manage Jobs Tab -->
        <div class="tab-content active" id="jobsTab">
            <h2>Job Management</h2>
            <div class="table-container">
                <table id="jobsTable">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Company</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Applicants</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="jobsTableBody">
                        <!-- Jobs will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Applications Tab -->
        <div class="tab-content" id="applicationsTab">
            <h2>Job Applications</h2>
            <div class="table-container">
                <table id="applicationsTable">
                    <thead>
                        <tr>
                            <th>Applicant</th>
                            <th>Job Title</th>
                            <th>Company</th>
                            <th>Applied Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="applicationsTableBody">
                        <!-- Applications will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Post Job Tab -->
        <div class="tab-content" id="postJobTab">
            <h2>Post New Job</h2>
            <form id="adminJobForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="jobTitle">Job Title *</label>
                        <input type="text" id="jobTitle" placeholder="e.g., Senior Frontend Developer" required>
                    </div>
                    <div class="form-group">
                        <label for="jobCompany">Company Name *</label>
                        <input type="text" id="jobCompany" placeholder="e.g., Tech Solutions Inc." required>
                    </div>
                    <div class="form-group">
                        <label for="jobLocation">Location</label>
                        <input type="text" id="jobLocation" placeholder="e.g., Remote, New York, etc.">
                    </div>
                    <div class="form-group">
                        <label for="jobSalary">Salary Range</label>
                        <input type="text" id="jobSalary" placeholder="e.g., $80,000 - $120,000">
                    </div>
                    <div class="form-group">
                        <label for="jobType">Job Type</label>
                        <select id="jobType">
                            <option value="Full-time">Full-time</option>
                            <option value="Part-time">Part-time</option>
                            <option value="Remote">Remote</option>
                            <option value="Contract">Contract</option>
                            <option value="Internship">Internship</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="jobExperience">Experience Level</label>
                        <select id="jobExperience">
                            <option value="Entry Level">Entry Level</option>
                            <option value="Mid Level">Mid Level</option>
                            <option value="Senior Level">Senior Level</option>
                            <option value="Any">Any</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="jobDescription">Job Description *</label>
                    <textarea id="jobDescription" placeholder="Detailed job description..." rows="4" required></textarea>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="jobRequirements">Requirements (one per line)</label>
                        <textarea id="jobRequirements" placeholder="• 3+ years of experience...&#10;• Strong JavaScript skills..." rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="jobResponsibilities">Responsibilities (one per line)</label>
                        <textarea id="jobResponsibilities" placeholder="• Develop new features...&#10;• Code review..." rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="jobBenefits">Benefits (one per line)</label>
                        <textarea id="jobBenefits" placeholder="• Health insurance&#10;• Flexible hours..." rows="5"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label for="applyLink">Application Link</label>
                    <input type="url" id="applyLink" placeholder="https://company.com/apply">
                </div>

                <div class="form-group">
                    <label for="jobDeadline">Application Deadline</label>
                    <input type="date" id="jobDeadline">
                </div>

                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-paper-plane"></i> Post Job
                </button>
            </form>
        </div>

        <!-- Users Tab -->
        <div class="tab-content" id="usersTab">
            <h2>Registered Users</h2>
            <div class="table-container">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Skills</th>
                            <th>Registered</th>
                            <th>Applications</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Admin JavaScript
        const API_BASE_URL = 'http://localhost:5000/api';
        let adminToken = localStorage.getItem('token');
        let currentUser = JSON.parse(localStorage.getItem('user'));

        // Check if user is admin
        if (!currentUser || currentUser.role !== 'admin') {
            window.location.href = '/';
        }

        // DOM Elements
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const adminTabs = document.querySelectorAll('.admin-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const adminJobForm = document.getElementById('adminJobForm');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadAdminStats();
            loadJobsForAdmin();
            loadApplications();
            loadUsers();
            
            setupAdminEventListeners();
        });

        function setupAdminEventListeners() {
            // Tabs
            adminTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    adminTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}Tab`) {
                            content.classList.add('active');
                        }
                    });
                });
            });

            // Logout
            adminLogoutBtn.addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/';
            });

            // Job Form
            adminJobForm.addEventListener('submit', handlePostJob);
        }

        async function loadAdminStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    const statsContainer = document.getElementById('adminStats');
                    
                    statsContainer.innerHTML = `
                        <div class="stat-card">
                            <h3>${stats.totalJobs}</h3>
                            <p>Total Jobs</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.activeJobs}</h3>
                            <p>Active Jobs</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.totalApplications}</h3>
                            <p>Applications</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.totalUsers}</h3>
                            <p>Registered Users</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadJobsForAdmin() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/jobs`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('jobsTableBody');
                    tbody.innerHTML = data.jobs.map(job => `
                        <tr>
                            <td><strong>${job.title}</strong></td>
                            <td>${job.company}</td>
                            <td>${job.type}</td>
                            <td>${job.location}</td>
                            <td>${job.applicants || 0}</td>
                            <td>
                                <span class="status status-${job.status === 'active' ? 'active' : 'inactive'}">
                                    ${job.status}
                                </span>
                            </td>
                            <td class="action-buttons">
                                <button class="action-btn btn-toggle" onclick="toggleJobStatus('${job.id}', '${job.status}')">
                                    ${job.status === 'active' ? 'Deactivate' : 'Activate'}
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
            }
        }

        async function toggleJobStatus(jobId, currentStatus) {
            try {
                const response = await fetch(`${API_BASE_URL}/jobs/${jobId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: currentStatus === 'active' ? 'inactive' : 'active'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadJobsForAdmin();
                    loadAdminStats();
                    showNotification('Job status updated successfully', 'success');
                }
            } catch (error) {
                console.error('Error updating job status:', error);
                showNotification('Error updating job status', 'error');
            }
        }

        async function loadApplications() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/applications`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('applicationsTableBody');
                    tbody.innerHTML = data.applications.map(app => `
                        <tr>
                            <td>
                                <strong>${app.userName}</strong><br>
                                <small>${app.userEmail}</small>
                            </td>
                            <td>${app.jobTitle}</td>
                            <td>${app.company}</td>
                            <td>${new Date(app.appliedAt).toLocaleDateString()}</td>
                            <td>
                                <span class="status status-${app.status}">
                                    ${app.status}
                                </span>
                            </td>
                            <td class="action-buttons">
                                <select class="status-select" data-id="${app.id}" onchange="updateApplicationStatus('${app.id}', this.value)">
                                    <option value="pending" ${app.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="reviewed" ${app.status === 'reviewed' ? 'selected' : ''}>Reviewed</option>
                                    <option value="accepted" ${app.status === 'accepted' ? 'selected' : ''}>Accepted</option>
                                    <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                                </select>
                                ${app.resume ? `<a href="${app.resume}" class="action-btn btn-edit" target="_blank">Resume</a>` : ''}
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading applications:', error);
            }
        }

        async function updateApplicationStatus(appId, status) {
            try {
                const response = await fetch(`${API_BASE_URL}/applications/${appId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Application status updated', 'success');
                }
            } catch (error) {
                console.error('Error updating application status:', error);
                showNotification('Error updating status', 'error');
            }
        }

        async function loadUsers() {
            try {
                // Note: We need to implement a users endpoint or get from local storage
                // For now, we'll load applications to show user data
                const response = await fetch(`${API_BASE_URL}/admin/applications`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Get unique users from applications
                    const users = {};
                    data.applications.forEach(app => {
                        if (!users[app.userId]) {
                            users[app.userId] = {
                                name: app.userName,
                                email: app.userEmail,
                                phone: app.userPhone || 'N/A',
                                skills: app.userSkills.length > 0 ? app.userSkills.join(', ') : 'None specified',
                                appliedAt: app.appliedAt,
                                applicationCount: 1
                            };
                        } else {
                            users[app.userId].applicationCount++;
                        }
                    });
                    
                    const tbody = document.getElementById('usersTableBody');
                    tbody.innerHTML = Object.values(users).map(user => `
                        <tr>
                            <td><strong>${user.name}</strong></td>
                            <td>${user.email}</td>
                            <td>${user.phone}</td>
                            <td>${user.skills}</td>
                            <td>${new Date(user.appliedAt).toLocaleDateString()}</td>
                            <td>${user.applicationCount}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function handlePostJob(e) {
            e.preventDefault();
            
            const jobData = {
                title: document.getElementById('jobTitle').value,
                company: document.getElementById('jobCompany').value,
                location: document.getElementById('jobLocation').value,
                salary: document.getElementById('jobSalary').value,
                type: document.getElementById('jobType').value,
                experience: document.getElementById('jobExperience').value,
                description: document.getElementById('jobDescription').value,
                requirements: document.getElementById('jobRequirements').value,
                responsibilities: document.getElementById('jobResponsibilities').value,
                benefits: document.getElementById('jobBenefits').value,
                applyLink: document.getElementById('applyLink').value,
                deadline: document.getElementById('jobDeadline').value
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/jobs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jobData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Job posted successfully!', 'success');
                    adminJobForm.reset();
                    loadJobsForAdmin();
                    loadAdminStats();
                    
                    // Switch to jobs tab
                    document.querySelector('[data-tab="jobs"]').click();
                } else {
                    showNotification(data.message || 'Failed to post job', 'error');
                }
            } catch (error) {
                console.error('Error posting job:', error);
                showNotification('Error posting job. Please try again.', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 3000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.remove();
            });
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Add notification animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            .notification-content {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .notification-close {
                background: none;
                border: none;
                color: white;
                font-size: 20px;
                cursor: pointer;
                padding: 0;
                margin-left: 10px;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>